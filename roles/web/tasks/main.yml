
# Install Required Python Libs

- apt: name=python-pycurl
       state=present


# Install & Configure Nginx

- apt_repository: repo='ppa:nginx/stable'
                  state=present

- apt: name=nginx-full
       state=present

- copy: src=nginx/nginx.conf
        dest=/etc/nginx/nginx.conf
  notify: reload nginx

- file: path=/etc/nginx/sites-available/default
        state=absent
  notify: reload nginx

- file: path=/etc/nginx/sites-enabled/default
        state=absent
  notify: reload nginx


#- copy: src=nginx/php.conf
#        dest=/etc/nginx/conf.d/php.conf
#  notify: reload nginx

# Install & Configure PHP

- apt_repository: repo='ppa:ondrej/php5'
                  state=present

- apt: name=php5-fpm
       state=present

- apt: name=php5-cli
       state=present


- file: path=/etc/php5/fpm/pool.d/www.conf
        state=absent
  notify: restart php-fpm


- name: Copy the php-fpm php.ini config file
  ini_file: dest=/etc/php5/fpm/conf.d/config.ini
            section=PHP
            option={{ item.option }}
            value={{ item.value }}
  with_items: php_config
  notify: restart php-fpm

- name: Copy the php-fpm php-fpm.conf configuration file
  ini_file: dest=/etc/php5/fpm/php-fpm.conf
            section={{ item.section }}
            option={{ item.option }}
            value={{ item.value }}
  with_items: fpm_config
  notify: restart php-fpm

- name: Copy the POOL configurations
  template: src=pool.conf
            dest=/etc/php5/fpm/pool.d/{{ item['pool']['name'] }}.conf
  with_items: fpm_pools
  when: fpm_pools|lower != 'none'
  notify: restart php-fpm

- name: Check php-fpm syntax of configuration files
  shell: php5-fpm -t
  register: result
  changed_when: "result.rc != 0"



# Composer

- name: check if /usr/local/bin/composer exists
  shell: test -x /usr/local/bin/composer
  ignore_errors: True
  register: phpComposerNotInstalled

- name: install composer
  shell: >
    curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin
  when: "phpComposerNotInstalled.rc != 0 and phpInstallComposer == true"

- name: move composer.phar to /usr/local/bin/composer
  shell: >
    mv /usr/local/bin/composer.phar /usr/local/bin/composer
  when: "phpComposerNotInstalled.rc != 0 and phpInstallComposer == true"


# Install Git

-  apt: name=git
        state=present



# Install & Configure TestApp

- user: name=testapp
        generate_ssh_key=yes
        shell=/bin/bash
        state=present

- file: path=/var/www/testapp/
        owner=testapp
        group=testapp
        mode=0775
        state=directory


- copy: src=nginx/sites-available/testapp
        dest=/etc/nginx/sites-available/default
  notify: reload nginx

- file: src=/etc/nginx/sites-available/default
        dest=/etc/nginx/sites-enabled/default
        state=link
  notify: reload nginx



- service: name=php5-fpm
           state=started
           enabled=yes


- service: name=nginx
           state=started
           enabled=yes
